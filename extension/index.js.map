{"version":3,"file":"index.js","sources":["../src/extension/lib/horaro.ts","../src/extension/programs.ts","../src/extension/index.ts"],"sourcesContent":["import got from 'got';\n\nconst BASE_URL = 'https://horaro.org/-/api/v1';\n\ntype HoraroResponse<D> = {\n  data: D;\n};\n\ntype Schedule = {\n  id: string;\n  name: string;\n  slug: string;\n  columns: string[];\n  items: ScheduleItem[];\n};\n\ntype ScheduleItem = {\n  length_t: number;\n  data: string[];\n};\n\n/**\n * Fetches a specific schedule by ID or slug.\n * @param {string} event - The ID or slug of the event.\n * @param {string} idOrSlug - The ID or slug of the schedule.\n * @returns {Promise<HoraroResponse<Schedule>>} - The response containing the schedule details.\n */\nexport async function fetchScheduleByIdOrSlug(\n  event: string,\n  idOrSlug: string,\n): Promise<HoraroResponse<Schedule>> {\n  const url = `${BASE_URL}/events/${event}/schedules/${idOrSlug}`;\n  return got(url).json();\n}\n","import { ServerNodecgInstance } from '../nodecg/nodecg';\nimport { Program } from '../nodecg/replicants';\nimport { fetchScheduleByIdOrSlug } from './lib/horaro';\nimport { err, ok } from 'neverthrow';\n\nconst defaultProgram: Program = {\n  name: '',\n  estimate: '0:00:00',\n  estimateInSeconds: 0,\n};\n\nconst horaroUrlToSlugs = (url: string) => {\n  const match = url.match(/horaro\\.org\\/([^/]+)\\/([^/]+)/);\n  if (!match) {\n    return null;\n  }\n  return {\n    event: match[1],\n    slug: match[2],\n  };\n};\n\nconst fetchColumns = async (url: string) => {\n  const slugs = horaroUrlToSlugs(url);\n  if (!slugs) {\n    return err('Invalid URL');\n  }\n\n  const { event, slug } = slugs;\n  const schedule = await fetchScheduleByIdOrSlug(event, slug);\n\n  return ok(schedule.data.columns);\n};\n\nconst fetchScheduleItems = async (url: string, columns: { title: number }) => {\n  const slugs = horaroUrlToSlugs(url);\n  if (!slugs) {\n    return err('Invalid URL');\n  }\n\n  const { event, slug } = slugs;\n  const schedule = await fetchScheduleByIdOrSlug(event, slug);\n\n  if (columns.title >= schedule.data.columns.length) {\n    return err('Invalid column index');\n  }\n\n  const items = schedule.data.items.map(item => ({\n    name: item.data[columns.title],\n    estimateInSeconds: item.length_t,\n  }));\n\n  return ok(items);\n};\n\nconst secondsToTimePresentation = (seconds: number) => {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  const secs = seconds % 60;\n\n  return `${hours}:${minutes.toString().padStart(2, '0')}:${secs\n    .toString()\n    .padStart(2, '0')}`;\n};\n\nconst programs = (nodecg: ServerNodecgInstance) => {\n  const logger = new nodecg.Logger('programs');\n  const programsRep = nodecg.Replicant('programs', {\n    defaultValue: [],\n  });\n  const currentProgram = nodecg.Replicant('current-program', {\n    defaultValue: defaultProgram,\n  });\n\n  nodecg.listenFor('programs:getColumns', async ({ url }, cb) => {\n    if (!cb || cb?.handled) {\n      return;\n    }\n    const columns = await fetchColumns(url);\n    if (columns.isErr()) {\n      logger.error(`Failed to fetch columns: ${columns.error}`);\n      return cb(columns.error);\n    }\n\n    logger.info(`Fetched columns: ${columns.value}`);\n    return cb(null, { columns: columns.value });\n  });\n\n  nodecg.listenFor('programs:loadSchedule', async ({ url, columns }, cb) => {\n    if (!cb || cb?.handled) {\n      return;\n    }\n    const items = await fetchScheduleItems(url, columns);\n    if (items.isErr()) {\n      logger.error(`Failed to fetch schedule items: ${items.error}`);\n      return cb(items.error);\n    }\n\n    programsRep.value = items.value.map(item => ({\n      ...item,\n      estimate: secondsToTimePresentation(item.estimateInSeconds),\n    }));\n\n    return cb(null);\n  });\n};\n\nexport default programs;\n","import { ServerNodecgInstance } from '../nodecg/nodecg.js';\nimport programs from './programs.js';\n\nexport default (nodecg: ServerNodecgInstance) => {\n  programs(nodecg);\n};\n"],"names":["got","err","ok"],"mappings":"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"}